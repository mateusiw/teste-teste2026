<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário Vet - Dr. Manuel Victor</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ícones -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Roboto+Slab:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* Estilos de Impressão e Folha A4 */
        @media print {
            @page { margin: 0; size: A4; }
            body { 
                background-color: white; 
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-area { 
                display: block !important; 
                width: 100%; 
                height: 100%; 
                position: absolute; 
                top: 0; 
                left: 0; 
                margin: 0; 
                padding: 0; 
                box-shadow: none !important;
                border: none !important;
            }
            input, select, textarea { border: none !important; background: transparent !important; resize: none; }
            /* Esconder setas de formulário na impressão */
            .select-arrow { display: none !important; }
            .appearance-none { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
            /* Forçar exibição de campos manuais se estiverem visíveis */
            .manual-input-visible { display: block !important; }
            
            /* Garantir que links pareçam texto normal mas funcionem */
            a { text-decoration: none; color: inherit; }
        }

        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            margin: auto;
            padding: 15mm 20mm 20mm 20mm; 
            box-sizing: border-box;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .doc-header h1 {
            font-family: 'Roboto Slab', serif; 
            letter-spacing: 0.5px;
        }
        .doc-info-label {
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            font-size: 0.75rem;
            margin-right: 4px;
        }
        .doc-info-value {
            border-bottom: 1px dotted #9ca3af;
            padding-bottom: 0px;
            padding-right: 10px;
            font-weight: 500;
            color: #111827;
            text-transform: uppercase;
        }
        
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 10rem;
            color: rgba(0,0,0,0.03);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
            white-space: nowrap;
        }

        /* Estilo da lista de medicamentos no formulário */
        .med-item {
            background: #f0fdfa;
            border-left: 4px solid #0f766e;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 4px 4px 0;
        }

        /* Classe utilitária para os Selects Chiques */
        .select-chic {
            appearance: none;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db;
            color: #374151;
            padding: 0.5rem 0.75rem;
            padding-right: 2rem; /* Espaço para a seta */
            border-radius: 0.375rem;
            line-height: 1.25;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .select-chic:focus {
            outline: none;
            ring: 2px;
            --tw-ring-color: #14b8a6; /* teal-500 */
            border-color: transparent;
        }
        .select-chic:hover {
            border-color: #5eead4; /* teal-300 */
        }
        /* Wrapper para posicionar a seta */
        .select-wrapper {
            position: relative;
        }
        .select-icon {
            pointer-events: none;
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding-left: 0.5rem;
            padding-right: 0.75rem;
            color: #6b7280; /* gray-500 */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Container Principal (Formulário) -->
    <div id="app-container" class="container mx-auto p-4 max-w-4xl no-print">
        
        <!-- Header do App -->
        <header class="mb-6 flex items-center justify-between bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">
                    Gerador de Documentos
                </h1>
                <p class="text-gray-500 text-sm">Configurado para: Dr. Manuel Victor</p>
            </div>
            <div class="flex gap-2">
                <div class="text-xs text-right mr-2 text-gray-400 hidden md:block">
                    <p>Para links clicáveis:</p>
                    <p>Use o botão <b>Imprimir</b></p>
                </div>
                <button onclick="exportarParaCSV()" class="text-green-700 hover:text-green-900 text-sm font-medium border border-green-200 px-4 py-2 rounded hover:bg-green-50 transition">
                    Salvar CSV
                </button>
                <button onclick="limparFormulario()" class="text-red-600 hover:text-red-800 text-sm font-medium border border-red-200 px-4 py-2 rounded hover:bg-red-50 transition">
                    Limpar Tudo
                </button>
            </div>
        </header>

        <form id="vetForm" onsubmit="event.preventDefault(); gerarRelatorio();" class="space-y-6">
            
            <!-- Dados do Profissional (Oculto) -->
            <div class="hidden">
                <input type="text" id="clinicaNome" value="DR. MANUEL VICTOR DOS SANTOS GOMES">
                <input type="text" id="clinicaCrmv" value="CRMV-PI: 02120 VP">
                <input type="text" id="clinicaEndereco" value="PRAÇA DA INDEPENDÊNCIA, N° 50, CENTRO, ALTOS PI, CEP 64.290-000">
                <input type="text" id="clinicaContatos" value="(86) 99427-5801 / (88) 99413-9399">
            </div>

            <!-- Seção 1: Dados do Atendimento -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Dados do Atendimento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Documento</label>
                        
                        <!-- Modo Lista Suspensa (Tipo de Documento) -->
                        <div id="wrapperTipoDocSelect" class="select-wrapper">
                            <select id="tipoDocumento" class="select-chic" onchange="verificarTipoDocManual(this)">
                                <option value="PRONTUÁRIO MÉDICO">Prontuário Médico</option>
                                <option value="RECEITUÁRIO">Receituário</option>
                                <option value="ENCAMINHAMENTO">Encaminhamento</option>
                                <option value="ATESTADO">Atestado</option>
                                <option value="Outro (Digitar)">Outro (Digitar)</option>
                            </select>
                            <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                        </div>

                        <!-- Modo Digitação Manual (Tipo de Documento) -->
                        <div id="wrapperTipoDocManual" class="hidden flex gap-1">
                            <input type="text" id="tipoDocumentoManual" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" placeholder="Digite o nome do documento..." oninput="atualizarTituloDocumento()">
                            <button type="button" onclick="cancelarTipoDocManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded" title="Voltar para lista">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="dataAtendimento" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm">
                    </div>
                </div>
            </div>

            <!-- Seção 2: Identificação -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Identificação</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Linha 1 -->
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Animal *</label>
                        <input type="text" id="animalNome" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" required placeholder="Ex: Rex (ou Trovão, Jiboia...)">
                    </div>
                    <div class="md:col-span-1">
                         <div class="flex gap-4">
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Espécie</label>
                                
                                <!-- Modo Lista Suspensa (Espécie) -->
                                <div id="wrapperEspecieSelect" class="select-wrapper">
                                    <select id="animalEspecie" class="select-chic" onchange="verificarEspecieManual(this)">
                                        <option value="Canina" selected>Canina</option>
                                        <option value="Felina">Felina</option>
                                        <option value="Equina">Equina (Cavalo)</option>
                                        <option value="Bovina">Bovina</option>
                                        <option value="Ave">Ave</option>
                                        <option value="Réptil">Réptil (Cobra/Lagarto)</option>
                                        <option value="Roedor">Roedor/Coelho</option>
                                        <option value="Outra (Digitar)">Outra (Digitar)</option>
                                    </select>
                                    <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                </div>

                                <!-- Modo Digitação Manual (Espécie) -->
                                <div id="wrapperEspecieManual" class="hidden flex gap-1">
                                    <input type="text" id="animalEspecieManual" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" placeholder="Digite a espécie...">
                                    <button type="button" onclick="cancelarEspecieManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded" title="Voltar para lista">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Raça / Tipo</label>
                                
                                <!-- Modo Lista Suspensa (Raça) -->
                                <div id="wrapperRacaSelect" class="select-wrapper">
                                    <select id="animalRacaSelect" class="select-chic" onchange="verificarRacaManual(this)">
                                        <!-- Preenchido via Javascript -->
                                    </select>
                                    <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                </div>

                                <!-- Modo Digitação Manual (Raça) -->
                                <div id="wrapperRacaManual" class="hidden flex gap-1">
                                    <input type="text" id="animalRacaManual" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" placeholder="Digite a raça/tipo...">
                                    <button type="button" onclick="cancelarRacaManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded" title="Voltar para lista">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Linha 2 -->
                    <div class="md:col-span-1">
                        <div class="flex gap-4">
                             <!-- NOVO CAMPO DE IDADE COM SELECT -->
                             <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Idade</label>
                                <div class="flex gap-2">
                                    <input type="number" id="animalIdadeValor" class="w-1/3 min-w-[60px] bg-white border border-gray-300 text-gray-700 py-2 px-2 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm text-center" placeholder="0">
                                    <div class="select-wrapper w-2/3">
                                        <select id="animalIdadeTipo" class="select-chic">
                                            <option value="Anos">Anos</option>
                                            <option value="Meses">Meses</option>
                                            <option value="Dias">Dias</option>
                                        </select>
                                        <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="w-1/2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Peso (kg)</label>
                                <input type="number" step="0.1" id="animalPeso" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm">
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sexo</label>
                        
                        <!-- Modo Lista Suspensa (Sexo) -->
                        <div id="wrapperSexoSelect" class="select-wrapper">
                            <select id="animalSexo" class="select-chic" onchange="verificarSexoManual(this)">
                                <option value="Macho">Macho</option>
                                <option value="Fêmea">Fêmea</option>
                                <option value="Indefinido">Indefinido (Aves/Répteis)</option>
                                <option value="Outro (Digitar)">Outro (Digitar)</option>
                            </select>
                            <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                        </div>

                        <!-- Modo Digitação Manual (Sexo) -->
                        <div id="wrapperSexoManual" class="hidden flex gap-1">
                            <input type="text" id="animalSexoManual" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" placeholder="Digite o sexo...">
                            <button type="button" onclick="cancelarSexoManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded" title="Voltar para lista">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Linha 3 (Tutor) -->
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Responsável (Tutor) *</label>
                        <input type="text" id="tutorNome" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" required>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">CPF do Responsável</label>
                        <input type="text" id="tutorCPF" oninput="mascaraCPF(this)" maxlength="14" class="w-full bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent text-sm" placeholder="000.000.000-00">
                    </div>
                </div>
            </div>

            <!-- Seção 3: Parâmetros Clínicos -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Parâmetros Clínicos</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500">TEMP (°C)</label>
                        <input type="number" step="0.1" id="paramTemp" class="w-full border-gray-300 rounded text-sm p-2 border focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">FC (bpm)</label>
                        <input type="number" id="paramFC" class="w-full border-gray-300 rounded text-sm p-2 border focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">FR (mpm)</label>
                        <input type="number" id="paramFR" class="w-full border-gray-300 rounded text-sm p-2 border focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">TPC (s)</label>
                        <input type="text" id="paramTPC" class="w-full border-gray-300 rounded text-sm p-2 border focus:outline-none focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Mucosas</label>
                        
                        <!-- Modo Lista Suspensa (Mucosas) -->
                        <div id="wrapperMucosasSelect" class="select-wrapper">
                            <select id="paramMucosas" class="select-chic" onchange="verificarMucosasManual(this)">
                                <option value="" class="text-gray-400">Selecione...</option>
                                <option value="Normocoradas">Normocoradas</option>
                                <option value="Pálidas">Pálidas</option>
                                <option value="Congestas">Congestas</option>
                                <option value="Ictéricas">Ictéricas</option>
                                <option value="Cianóticas">Cianóticas</option>
                                <option value="Outro (Digitar)">Outro (Digitar)</option>
                            </select>
                            <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                        </div>

                        <!-- Modo Digitação Manual (Mucosas) -->
                        <div id="wrapperMucosasManual" class="hidden flex gap-1">
                            <input type="text" id="paramMucosasManual" class="w-full border-gray-300 rounded text-sm p-2 border focus:outline-none focus:ring-2 focus:ring-teal-500" placeholder="Digite...">
                            <button type="button" onclick="cancelarMucosasManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded" title="Voltar para lista">
                                <i class="fa-solid fa-xmark"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seção 4: Conteúdo do Documento -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Conteúdo Clínico</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Anamnese / Histórico</label>
                        <textarea id="textoAnamnese" rows="3" class="w-full rounded-md border-gray-300 shadow-sm border p-2 focus:border-teal-500 focus:ring-teal-200"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Exame Físico / Diagnóstico</label>
                        <textarea id="textoDiagnostico" rows="3" class="w-full rounded-md border-gray-300 shadow-sm border p-2 focus:border-teal-500 focus:ring-teal-200"></textarea>
                    </div>
                </div>

                <!-- CONSTRUTOR DE RECEITA -->
                <div class="bg-teal-50 p-4 rounded-lg border border-teal-200">
                    <h3 class="font-bold text-teal-800 mb-3 uppercase text-sm tracking-wide flex items-center gap-2">
                        <i class="fa-solid fa-pills"></i> Montar Receita / Prescrição
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-3">
                        <!-- Medicamento -->
                        <div class="md:col-span-4">
                            <label class="block text-xs font-bold text-gray-600 mb-1">MEDICAMENTO</label>
                            
                            <!-- Select Medicamento -->
                            <div id="wrapperMedicamentoSelect" class="select-wrapper">
                                <select id="rxMedicamento" class="select-chic" onchange="verificarMedicamentoManual(this)">
                                    <option value="" disabled selected>Selecione...</option>
                                    <optgroup label="Antibióticos">
                                        <option value="Amoxicilina">Amoxicilina</option>
                                        <option value="Amoxicilina + Clavulanato">Amoxicilina + Clavulanato</option>
                                        <option value="Cefalexina">Cefalexina</option>
                                        <option value="Doxiciclina">Doxiciclina</option>
                                        <option value="Enrofloxacina">Enrofloxacina</option>
                                        <option value="Metronidazol">Metronidazol</option>
                                    </optgroup>
                                    <optgroup label="Anti-inflamatórios/Cort">
                                        <option value="Meloxicam">Meloxicam</option>
                                        <option value="Ketoprofeno">Ketoprofeno</option>
                                        <option value="Carprofeno">Carprofeno</option>
                                        <option value="Prednisolona">Prednisolona</option>
                                        <option value="Dexametasona">Dexametasona</option>
                                    </optgroup>
                                    <optgroup label="Analgesia">
                                        <option value="Dipirona">Dipirona</option>
                                        <option value="Tramadol">Tramadol</option>
                                        <option value="Gabapentina">Gabapentina</option>
                                    </optgroup>
                                    <optgroup label="Gastro/Outros">
                                        <option value="Omeprazol">Omeprazol</option>
                                        <option value="Ondansetrona">Ondansetrona</option>
                                        <option value="Ranitidina">Ranitidina</option>
                                        <option value="Simparic">Simparic</option>
                                        <option value="Bravecto">Bravecto</option>
                                        <option value="Nexgard">Nexgard</option>
                                        <option value="Drontal">Drontal</option>
                                    </optgroup>
                                    <option value="Outro (Digitar)">Outro (Digitar)</option>
                                </select>
                                <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>

                            <!-- Manual Medicamento -->
                            <div id="wrapperMedicamentoManual" class="hidden flex gap-1">
                                <input type="text" id="rxMedicamentoManual" class="w-full rounded border-gray-300 text-sm p-2 focus:ring-teal-500 focus:border-teal-500" placeholder="Nome do medicamento...">
                                <button type="button" onclick="cancelarMedicamentoManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-3 rounded" title="Voltar para lista">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Concentração -->
                        <div class="md:col-span-2">
                            <label class="block text-xs font-bold text-gray-600 mb-1">MG / CONC.</label>
                            
                            <!-- Select Dosagem -->
                            <div id="wrapperDosagemSelect" class="select-wrapper">
                                <select id="rxDosagem" class="select-chic" onchange="verificarDosagemManual(this)">
                                    <option value="">Selecione...</option>
                                    <option value="Xarope/Susp.">Xarope/Susp.</option>
                                    <option value="Gotas">Gotas</option>
                                    <option value="10mg">10mg</option>
                                    <option value="20mg">20mg</option>
                                    <option value="25mg">25mg</option>
                                    <option value="50mg">50mg</option>
                                    <option value="100mg">100mg</option>
                                    <option value="200mg">200mg</option>
                                    <option value="250mg">250mg</option>
                                    <option value="500mg">500mg</option>
                                    <option value="1g">1g</option>
                                    <option value="Outro (Digitar)">Outro (Digitar)</option>
                                </select>
                                <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>

                            <!-- Manual Dosagem -->
                            <div id="wrapperDosagemManual" class="hidden flex gap-1">
                                <input type="text" id="rxDosagemManual" class="w-full rounded border-gray-300 text-sm p-2" placeholder="Ex: 5ml">
                                <button type="button" onclick="cancelarDosagemManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 rounded" title="Voltar para lista">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Frequência -->
                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-600 mb-1">FREQUÊNCIA (DIA)</label>
                            
                            <!-- Select Frequencia -->
                            <div id="wrapperFrequenciaSelect" class="select-wrapper">
                                <select id="rxFrequencia" class="select-chic" onchange="verificarFrequenciaManual(this)">
                                    <option value="a cada 24h (SID)">1x ao dia (24h)</option>
                                    <option value="a cada 12h (BID)">2x ao dia (12h)</option>
                                    <option value="a cada 8h (TID)">3x ao dia (8h)</option>
                                    <option value="a cada 6h (QID)">4x ao dia (6h)</option>
                                    <option value="a cada 48h">Dias alternados</option>
                                    <option value="dose única">Dose Única</option>
                                    <option value="Outro (Digitar)">Outro (Digitar)</option>
                                </select>
                                <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                            </div>

                            <!-- Manual Frequencia -->
                            <div id="wrapperFrequenciaManual" class="hidden flex gap-1">
                                <input type="text" id="rxFrequenciaManual" class="w-full rounded border-gray-300 text-sm p-2" placeholder="Ex: a cada 4 horas">
                                <button type="button" onclick="cancelarFrequenciaManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 rounded" title="Voltar para lista">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Tempo -->
                        <div class="md:col-span-3 flex gap-2">
                            <div class="w-full">
                                <label class="block text-xs font-bold text-gray-600 mb-1">TEMPO DE USO</label>
                                
                                <!-- Select Tempo -->
                                <div id="wrapperTempoSelect" class="select-wrapper">
                                    <select id="rxTempo" class="select-chic" onchange="verificarTempoManual(this)">
                                        <option value="uso único">Uso Único</option>
                                        <option value="por 3 dias">3 dias</option>
                                        <option value="por 5 dias">5 dias</option>
                                        <option value="por 7 dias">7 dias</option>
                                        <option value="por 10 dias">10 dias</option>
                                        <option value="por 14 dias">14 dias</option>
                                        <option value="por 21 dias">21 dias</option>
                                        <option value="por 30 dias">30 dias</option>
                                        <option value="uso contínuo">Uso contínuo</option>
                                        <option value="Outro (Digitar)">Outro (Digitar)</option>
                                    </select>
                                    <div class="select-icon"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                </div>

                                <!-- Manual Tempo -->
                                <div id="wrapperTempoManual" class="hidden flex gap-1">
                                    <input type="text" id="rxTempoManual" class="w-full rounded border-gray-300 text-sm p-2" placeholder="Ex: até acabar">
                                    <button type="button" onclick="cancelarTempoManual()" class="bg-gray-200 hover:bg-gray-300 text-gray-600 px-2 rounded" title="Voltar para lista">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex items-end">
                                <button type="button" onclick="adicionarMedicamento()" class="bg-teal-600 hover:bg-teal-700 text-white p-2 rounded shadow h-[38px] w-[38px] flex items-center justify-center" title="Adicionar à lista">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Lista Visual dos Medicamentos Adicionados -->
                    <div id="listaMedicamentosContainer" class="bg-white rounded border border-gray-200 min-h-[50px] p-2 mb-3">
                        <p class="text-xs text-gray-400 italic text-center p-2" id="msgVazio">Nenhum medicamento adicionado.</p>
                        <!-- Itens serão inseridos aqui via JS -->
                    </div>

                    <!-- Obs Adicionais -->
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">OUTRAS ORIENTAÇÕES (Limpeza, Dieta, etc)</label>
                        <textarea id="textoOrientacoes" rows="3" class="w-full rounded border-gray-300 text-sm p-2" placeholder="Ex: Limpar a ferida com soro fisiológico 2x ao dia..."></textarea>
                    </div>
                </div>

            </div>

            <button type="submit" class="w-full bg-teal-700 hover:bg-teal-800 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition duration-200 flex justify-center items-center gap-2 text-lg uppercase tracking-wide">
                GERAR DOCUMENTO
            </button>
        </form>
    </div>

    <!-- MODO VISUALIZAÇÃO / IMPRESSÃO -->
    <div id="report-view" class="hidden">
        
        <!-- Controles -->
        <div class="container mx-auto max-w-4xl p-4 flex flex-col md:flex-row justify-between items-center gap-3 no-print mb-4 bg-gray-100 rounded-lg mt-4 border border-gray-200">
            <button onclick="editarRelatorio()" class="text-gray-600 hover:text-gray-900 font-medium py-2 px-4 flex items-center gap-2">
                <i class="fa-solid fa-arrow-left"></i> Voltar à edição
            </button>
            <div class="flex gap-2">
                <button onclick="baixarPDF()" class="bg-teal-700 hover:bg-teal-800 text-white font-semibold py-2 px-6 rounded shadow flex items-center gap-2">
                    Baixar PDF
                </button>
                <button onclick="window.print()" class="bg-gray-700 hover:bg-gray-800 text-white font-semibold py-2 px-6 rounded shadow flex items-center gap-2">
                    Imprimir
                </button>
            </div>
        </div>

        <!-- FOLHA A4 - LAYOUT DO MODELO ENVIADO -->
        <div class="a4-paper print-area" id="documento-final">
            
            <!-- Marca d'água de fundo (suave) -->
            <div class="watermark" id="watermarkText">PRONTUÁRIO</div>

            <!-- Cabeçalho Centralizado -->
            <div class="doc-header text-center mb-6">
                <h1 class="text-2xl font-bold text-black uppercase" id="printClinicaNome">DR. MANUEL VICTOR DOS SANTOS GOMES</h1>
                <p class="font-bold text-sm text-gray-800 mt-1" id="printCrmv">CRMV-PI: 02120 VP</p>
                <p class="text-xs text-gray-600 mt-1 uppercase tracking-wide" id="printEndereco">PRAÇA DA INDEPENDÊNCIA, N° 50, CENTRO, ALTOS PI, CEP 64.290-000</p>
                <div class="text-xs text-gray-600 font-medium" id="printContatos">
                    <!-- Links serão injetados aqui -->
                </div>
            </div>

            <!-- Barra de Título do Documento -->
            <div class="text-center mb-6 border-t border-b border-gray-300 py-1">
                <h2 class="text-xl font-bold text-gray-800 uppercase tracking-widest" id="printTipoDoc">PRONTUÁRIO MÉDICO</h2>
            </div>

            <!-- Bloco de Identificação (Estilo Linha) -->
            <div class="mb-6 px-2">
                <!-- Linha 1: Nome, Idade, Raça, Espécie -->
                <div class="flex flex-wrap items-baseline mb-2">
                    <span class="doc-info-label">NOME:</span>
                    <div class="flex-grow doc-info-value mr-4" id="printAnimal">---</div>
                    
                    <span class="doc-info-label">IDADE:</span>
                    <div class="w-16 doc-info-value mr-4 text-center" id="printIdade">--</div>
                    
                    <span class="doc-info-label">ESPÉCIE:</span>
                    <div class="w-20 doc-info-value mr-4" id="printEspecie">--</div>

                    <span class="doc-info-label">RAÇA:</span>
                    <div class="w-32 doc-info-value" id="printRaca">--</div>
                </div>

                <!-- Linha 2: Responsável, CPF -->
                <div class="flex flex-wrap items-baseline">
                    <span class="doc-info-label">RESPONSÁVEL:</span>
                    <div class="flex-grow doc-info-value mr-4" id="printTutor">---</div>
                    
                    <span class="doc-info-label">CPF:</span>
                    <div class="w-40 doc-info-value" id="printCpf">---</div>
                </div>

                <!-- Linha 3: Sexo e Outros (Aparecerá só se necessário ou customizado) -->
                <!-- Sexo adicionado a pedidos -->
                <div class="flex flex-wrap items-baseline mt-2">
                    <span class="doc-info-label">SEXO:</span>
                    <div class="flex-grow doc-info-value" id="printSexo">---</div>
                </div>

                <!-- Linha Oculta de Parâmetros -->
                <div id="printParametrosBox" class="mt-3 text-xs border border-gray-200 rounded p-2 bg-gray-50 hidden">
                    <span class="font-bold mr-2">PARÂMETROS:</span>
                    <span class="mr-3">Peso: <span id="printPeso">--</span>kg</span>
                    <span class="mr-3">Temp: <span id="printTemp">--</span>°C</span>
                    <span class="mr-3">FC: <span id="printFC">--</span></span>
                    <span class="mr-3">FR: <span id="printFR">--</span></span>
                    <span class="mr-3">TPC: <span id="printTPC">--</span></span>
                    <span class="mr-3">Mucosas: <span id="printMucosas">--</span></span>
                </div>
            </div>

            <!-- Corpo do Texto -->
            <div class="flex-grow px-4 py-2 text-sm leading-relaxed text-justify space-y-6">
                
                <!-- Anamnese -->
                <div id="boxAnamnese">
                    <h3 class="font-bold text-gray-800 underline text-xs mb-1 uppercase">Anamnese:</h3>
                    <p id="printAnamnese" class="whitespace-pre-line text-gray-700 mb-2"></p>
                </div>

                <!-- Diagnóstico -->
                <div id="boxDiagnostico">
                    <h3 class="font-bold text-gray-800 underline text-xs mb-1 uppercase">Diagnóstico / Exame Físico:</h3>
                    <p id="printDiagnostico" class="whitespace-pre-line text-gray-700 mb-2"></p>
                </div>

                <!-- Prescrição (Maior Destaque) -->
                <div id="boxTratamento" class="mt-4">
                    <h3 class="font-bold text-gray-800 underline text-xs mb-2 uppercase">Prescrição / Conduta:</h3>
                    <div id="printTratamento" class="whitespace-pre-line text-gray-900 font-medium text-base ml-2"></div>
                </div>

            </div>

            <!-- Data e Local -->
            <div class="text-right mt-8 px-4 mb-10">
                <p class="text-sm text-gray-600">
                    Altos - PI, <span id="printDataExtenso">00 de Janeiro de 0000</span>.
                </p>
            </div>

            <!-- Rodapé Fixo -->
            <div class="mt-auto pt-4 text-center">
                <!-- Assinatura -->
                <div class="mb-8 flex flex-col items-center">
                    <div class="w-64 border-b border-black mb-2"></div>
                    <p class="font-bold text-sm uppercase">DR. MANUEL VICTOR DOS SANTOS GOMES</p>
                    <p class="text-xs font-bold text-gray-600">CRMV-PI: 02120 VP</p>
                </div>

                <!-- Footer Branding -->
                <div class="border-t-2 border-gray-800 pt-3 pb-2 flex justify-between items-center px-8 text-xs font-bold text-gray-700 uppercase tracking-wider">
                    <div class="flex items-center gap-1">
                        <a href="https://www.instagram.com/mv.manuelvictor/" target="_blank" class="flex items-center gap-1 hover:text-black hover:underline">
                            <i class="fa-brands fa-instagram"></i> MV.MANUELVICTOR
                        </a>
                    </div>
                    <div>
                         <a href="https://wa.me/5588994139399" target="_blank" class="hover:text-black">(88) 99413-9399</a>
                    </div>
                </div>
                <!-- RODAPÉ DINÂMICO -->
                <div class="bg-gray-800 text-white text-[10px] py-1 uppercase tracking-widest w-full" id="printFooterTipo">
                    Receituário Médico Veterinário
                </div>
            </div>

        </div>
        <div class="h-20 w-full no-print"></div>
    </div>

    <script>
        // Array para armazenar os medicamentos adicionados
        let listaReceita = [];

        // Dados de Raças para filtrar
        const racas = {
            'Canina': ["SRD (Sem Raça Definida)", "Shih Tzu", "Yorkshire", "Poodle", "Lhasa Apso", "Buldogue Francês", "Golden Retriever", "Labrador", "Pinscher", "Schnauzer", "Spitz Alemão", "Pit Bull", "Chow Chow", "Pug", "Rottweiler", "Beagle", "Dachshund", "Border Collie", "Pastor Alemão", "Outra (Digitar)"],
            'Felina': ["SRD (Sem Raça Definida)", "Siamês", "Persa", "Angorá", "Maine Coon", "Ragdoll", "Outra (Digitar)"],
            'Equina': ["SRD (Sem Raça Definida)", "Quarto de Milha", "Mangalarga Marchador", "Crioulo", "Paint Horse", "Puro Sangue Inglês (PSI)", "Pônei", "Outra (Digitar)"],
            'Bovina': ["SRD (Sem Raça Definida)", "Nelore", "Holandês", "Angus", "Brahman", "Girolando", "Outra (Digitar)"],
            'Ave': ["Calopsita", "Canário", "Papagaio", "Periquito", "Galinha", "Pato", "Outra (Digitar)"],
            'Réptil': ["Serpente / Cobra", "Iguana", "Jabuti / Tartaruga", "Lagarto", "Outra (Digitar)"],
            'Roedor': ["Coelho", "Porquinho da Índia", "Hamster", "Chinchila", "Rato", "Outra (Digitar)"],
            'Outra (Digitar)': ["Outra (Digitar)"],
            'Outra': ["Outra (Digitar)"]
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('dataAtendimento').valueAsDate = new Date();
            // Inicializa as raças com o valor padrão (Canina)
            atualizarRacas();
            atualizarTituloDocumento();
        });

        // ============================================
        // Lógica para Tipo de Documento Manual
        // ============================================
        function verificarTipoDocManual(select) {
            // Check for correct masculine value "Outro (Digitar)"
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperTipoDocSelect').classList.add('hidden');
                document.getElementById('wrapperTipoDocManual').classList.remove('hidden');
                document.getElementById('wrapperTipoDocManual').classList.add('flex');
                document.getElementById('tipoDocumentoManual').focus();
                atualizarTituloDocumento();
            } else {
                atualizarTituloDocumento();
            }
        }

        function cancelarTipoDocManual() {
            document.getElementById('wrapperTipoDocManual').classList.add('hidden');
            document.getElementById('wrapperTipoDocManual').classList.remove('flex');
            document.getElementById('wrapperTipoDocSelect').classList.remove('hidden');
            
            const select = document.getElementById('tipoDocumento');
            select.value = "PRONTUÁRIO MÉDICO"; 
            document.getElementById('tipoDocumentoManual').value = "";
            atualizarTituloDocumento();
        }

        function atualizarTituloDocumento() {
            const select = document.getElementById('tipoDocumento');
            let tipo = "";
            
            if (select.value === 'Outro (Digitar)') {
                tipo = document.getElementById('tipoDocumentoManual').value || "DOCUMENTO";
            } else {
                tipo = select.value;
            }
            
            // Atualiza a marca d'água e o rodapé
            const primeiraPalavra = tipo.split(' ')[0] || "DOC";
            document.getElementById('watermarkText').innerText = primeiraPalavra.toUpperCase(); 
            
            // Atualiza o rodapé para combinar com o título
            document.getElementById('printFooterTipo').innerText = tipo.toUpperCase() + " MÉDICO VETERINÁRIO";
        }

        // ============================================
        // Lógica para Espécie Manual
        // ============================================
        function verificarEspecieManual(select) {
            if (select.value === 'Outra (Digitar)') {
                document.getElementById('wrapperEspecieSelect').classList.add('hidden');
                document.getElementById('wrapperEspecieManual').classList.remove('hidden');
                document.getElementById('wrapperEspecieManual').classList.add('flex');
                document.getElementById('animalEspecieManual').focus();
                
                // Atualiza raças para permitir digitar qualquer coisa ou genérico
                atualizarRacas('Outra'); 
            } else {
                atualizarRacas();
            }
        }

        function cancelarEspecieManual() {
            document.getElementById('wrapperEspecieManual').classList.add('hidden');
            document.getElementById('wrapperEspecieManual').classList.remove('flex');
            document.getElementById('wrapperEspecieSelect').classList.remove('hidden');
            
            const select = document.getElementById('animalEspecie');
            select.value = "Canina"; 
            document.getElementById('animalEspecieManual').value = "";
            atualizarRacas();
        }

        // Atualizar lista de raças
        function atualizarRacas(forcedEspecie = null) {
            const selectEspecie = document.getElementById('animalEspecie');
            const especie = forcedEspecie || selectEspecie.value;
            const selectRaca = document.getElementById('animalRacaSelect');
            
            // Limpa opções atuais
            selectRaca.innerHTML = '<option value="" disabled selected>Selecione...</option>';
            
            // Pega a lista correta e popula
            const lista = racas[especie] || racas['Outra'];
            
            lista.forEach(raca => {
                const opt = document.createElement('option');
                opt.value = raca;
                opt.innerText = raca;
                selectRaca.appendChild(opt);
            });

            // Reseta para o modo select caso estivesse no manual
            cancelarRacaManual();
        }

        // ============================================
        // Lógica para Raça Manual
        // ============================================
        function verificarRacaManual(select) {
            if (select.value === 'Outra (Digitar)') {
                document.getElementById('wrapperRacaSelect').classList.add('hidden');
                document.getElementById('wrapperRacaManual').classList.remove('hidden');
                document.getElementById('wrapperRacaManual').classList.add('flex');
                document.getElementById('animalRacaManual').focus();
            }
        }

        function cancelarRacaManual() {
            document.getElementById('wrapperRacaManual').classList.add('hidden');
            document.getElementById('wrapperRacaManual').classList.remove('flex');
            document.getElementById('wrapperRacaSelect').classList.remove('hidden');
            
            // Reseta o select para o primeiro item (ou vazio)
            const select = document.getElementById('animalRacaSelect');
            select.value = "";
            document.getElementById('animalRacaManual').value = "";
        }

        // ============================================
        // Lógica para Sexo Manual
        // ============================================
        function verificarSexoManual(select) {
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperSexoSelect').classList.add('hidden');
                document.getElementById('wrapperSexoManual').classList.remove('hidden');
                document.getElementById('wrapperSexoManual').classList.add('flex');
                document.getElementById('animalSexoManual').focus();
            }
        }

        function cancelarSexoManual() {
            document.getElementById('wrapperSexoManual').classList.add('hidden');
            document.getElementById('wrapperSexoManual').classList.remove('flex');
            document.getElementById('wrapperSexoSelect').classList.remove('hidden');
            
            // Reseta o select para o padrão
            const select = document.getElementById('animalSexo');
            select.value = "Macho"; 
            document.getElementById('animalSexoManual').value = "";
        }

        // ============================================
        // Lógica para Mucosas Manual
        // ============================================
        function verificarMucosasManual(select) {
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperMucosasSelect').classList.add('hidden');
                document.getElementById('wrapperMucosasManual').classList.remove('hidden');
                document.getElementById('wrapperMucosasManual').classList.add('flex');
                document.getElementById('paramMucosasManual').focus();
            }
        }

        function cancelarMucosasManual() {
            document.getElementById('wrapperMucosasManual').classList.add('hidden');
            document.getElementById('wrapperMucosasManual').classList.remove('flex');
            document.getElementById('wrapperMucosasSelect').classList.remove('hidden');
            
            // Reseta o select
            const select = document.getElementById('paramMucosas');
            select.value = ""; 
            document.getElementById('paramMucosasManual').value = "";
        }

        // ============================================
        // Lógica para Receita Manual
        // ============================================
        // Medicamento
        function verificarMedicamentoManual(select) {
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperMedicamentoSelect').classList.add('hidden');
                document.getElementById('wrapperMedicamentoManual').classList.remove('hidden');
                document.getElementById('wrapperMedicamentoManual').classList.add('flex');
                document.getElementById('rxMedicamentoManual').focus();
            }
        }
        function cancelarMedicamentoManual() {
            document.getElementById('wrapperMedicamentoManual').classList.add('hidden');
            document.getElementById('wrapperMedicamentoManual').classList.remove('flex');
            document.getElementById('wrapperMedicamentoSelect').classList.remove('hidden');
            document.getElementById('rxMedicamento').value = "";
            document.getElementById('rxMedicamentoManual').value = "";
        }

        // Dosagem
        function verificarDosagemManual(select) {
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperDosagemSelect').classList.add('hidden');
                document.getElementById('wrapperDosagemManual').classList.remove('hidden');
                document.getElementById('wrapperDosagemManual').classList.add('flex');
                document.getElementById('rxDosagemManual').focus();
            }
        }
        function cancelarDosagemManual() {
            document.getElementById('wrapperDosagemManual').classList.add('hidden');
            document.getElementById('wrapperDosagemManual').classList.remove('flex');
            document.getElementById('wrapperDosagemSelect').classList.remove('hidden');
            document.getElementById('rxDosagem').value = "";
            document.getElementById('rxDosagemManual').value = "";
        }

        // Frequencia
        function verificarFrequenciaManual(select) {
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperFrequenciaSelect').classList.add('hidden');
                document.getElementById('wrapperFrequenciaManual').classList.remove('hidden');
                document.getElementById('wrapperFrequenciaManual').classList.add('flex');
                document.getElementById('rxFrequenciaManual').focus();
            }
        }
        function cancelarFrequenciaManual() {
            document.getElementById('wrapperFrequenciaManual').classList.add('hidden');
            document.getElementById('wrapperFrequenciaManual').classList.remove('flex');
            document.getElementById('wrapperFrequenciaSelect').classList.remove('hidden');
            document.getElementById('rxFrequencia').value = "";
            document.getElementById('rxFrequenciaManual').value = "";
        }

        // Tempo
        function verificarTempoManual(select) {
            if (select.value === 'Outro (Digitar)') {
                document.getElementById('wrapperTempoSelect').classList.add('hidden');
                document.getElementById('wrapperTempoManual').classList.remove('hidden');
                document.getElementById('wrapperTempoManual').classList.add('flex');
                document.getElementById('rxTempoManual').focus();
            }
        }
        function cancelarTempoManual() {
            document.getElementById('wrapperTempoManual').classList.add('hidden');
            document.getElementById('wrapperTempoManual').classList.remove('flex');
            document.getElementById('wrapperTempoSelect').classList.remove('hidden');
            document.getElementById('rxTempo').value = "";
            document.getElementById('rxTempoManual').value = "";
        }

        // Máscara para CPF
        function mascaraCPF(i) {
            let v = i.value.replace(/\D/g, ""); // Remove tudo que não é dígito
            
            if (v.length > 11) v = v.slice(0, 11); // Limita a 11 dígitos

            // Coloca ponto e traço
            if (v.length > 9) {
                v = v.replace(/(\d{3})(\d{3})(\d{3})(\d{1,2})/, "$1.$2.$3-$4");
            } else if (v.length > 6) {
                v = v.replace(/(\d{3})(\d{3})(\d{1,3})/, "$1.$2.$3");
            } else if (v.length > 3) {
                v = v.replace(/(\d{3})(\d{1,3})/, "$1.$2");
            }
            
            i.value = v;
        }

        // Função para Adicionar Medicamento à Lista
        function adicionarMedicamento() {
            let nome = document.getElementById('rxMedicamento').value;
            if (nome === 'Outro (Digitar)') nome = document.getElementById('rxMedicamentoManual').value;

            let dose = document.getElementById('rxDosagem').value;
            if (dose === 'Outro (Digitar)') dose = document.getElementById('rxDosagemManual').value;

            let freq = document.getElementById('rxFrequencia').value;
            if (freq === 'Outro (Digitar)') freq = document.getElementById('rxFrequenciaManual').value;

            let tempo = document.getElementById('rxTempo').value;
            if (tempo === 'Outro (Digitar)') tempo = document.getElementById('rxTempoManual').value;

            if (!nome) {
                alert("Selecione ou digite pelo menos o nome do medicamento.");
                return;
            }

            // Formatação do texto
            // Se dose não estiver vazia, adiciona espaço
            let textoDose = dose ? ` ${dose}` : '';
            // Se freq não estiver vazia, adiciona prefixo
            let textoFreq = freq ? ` - ${freq}` : '';
            // Se tempo não estiver vazio, adiciona espaço
            let textoTempo = tempo ? ` ${tempo}` : '';

            // Texto completo
            let textoCompleto = `<b>${nome}${textoDose}</b>${textoFreq}${textoTempo}.`;

            // Cria objeto
            const item = {
                id: Date.now(),
                texto: textoCompleto
            };

            listaReceita.push(item);
            renderizarListaReceita();
            
            // Limpa campos para o próximo (reseta para select vazio)
            cancelarMedicamentoManual();
            cancelarDosagemManual();
            cancelarFrequenciaManual();
            cancelarTempoManual();
        }

        // Função para Renderizar a Lista no Formulário
        function renderizarListaReceita() {
            const container = document.getElementById('listaMedicamentosContainer');
            container.innerHTML = '';

            if (listaReceita.length === 0) {
                document.getElementById('msgVazio').style.display = 'block';
                return;
            }

            listaReceita.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'med-item shadow-sm';
                div.innerHTML = `
                    <div class="text-sm text-gray-700">${index + 1}. ${item.texto}</div>
                    <button type="button" onclick="removerMedicamento(${item.id})" class="text-red-500 hover:text-red-700 ml-2">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Função para Remover Item
        function removerMedicamento(id) {
            listaReceita = listaReceita.filter(item => item.id !== id);
            renderizarListaReceita();
        }

        function gerarRelatorio() {
            // Lógica para pegar o Tipo de Documento correto
            let tipoDocFinal = "";
            const selectTipoDoc = document.getElementById('tipoDocumento');
            if (selectTipoDoc.value === 'Outra (Digitar)') {
                tipoDocFinal = document.getElementById('tipoDocumentoManual').value || "DOCUMENTO";
            } else {
                tipoDocFinal = selectTipoDoc.value;
            }

            // Lógica para pegar a espécie correta
            let especieFinal = "";
            const selectEspecie = document.getElementById('animalEspecie');
            if (selectEspecie.value === 'Outra (Digitar)') {
                especieFinal = document.getElementById('animalEspecieManual').value || "Não informada";
            } else {
                especieFinal = selectEspecie.value || "---";
            }

            // Lógica para pegar a raça correta (Select ou Manual)
            let racaFinal = "";
            const selectRaca = document.getElementById('animalRacaSelect');
            if (selectRaca.value === 'Outra (Digitar)') {
                racaFinal = document.getElementById('animalRacaManual').value || "Não informada";
            } else {
                racaFinal = selectRaca.value || "---";
            }

            // Lógica para pegar o sexo correto (Select ou Manual)
            let sexoFinal = "";
            const selectSexo = document.getElementById('animalSexo');
            if (selectSexo.value === 'Outro (Digitar)') {
                sexoFinal = document.getElementById('animalSexoManual').value || "Não informado";
            } else {
                sexoFinal = selectSexo.value || "---";
            }

            // Lógica para pegar Mucosas correto
            let mucosasFinal = "";
            const selectMucosas = document.getElementById('paramMucosas');
            if (selectMucosas.value === 'Outro (Digitar)') {
                mucosasFinal = document.getElementById('paramMucosasManual').value || "---";
            } else {
                mucosasFinal = selectMucosas.value || "---";
            }

            // Lógica Idade (Valor + Tipo)
            const idadeVal = document.getElementById('animalIdadeValor').value;
            const idadeTipo = document.getElementById('animalIdadeTipo').value;
            const idadeFinal = idadeVal ? `${idadeVal} ${idadeTipo}` : '---';

            // Preenche os campos manualmente pois têm lógica especial
            document.getElementById('printTipoDoc').innerText = tipoDocFinal.toUpperCase();
            document.getElementById('printEspecie').innerText = especieFinal;
            document.getElementById('printRaca').innerText = racaFinal;
            document.getElementById('printSexo').innerText = sexoFinal; 
            document.getElementById('printMucosas').innerText = mucosasFinal;
            document.getElementById('printIdade').innerText = idadeFinal; // Atualiza Idade

            // Injetar links de telefone no cabeçalho
            const headerContacts = document.getElementById('printContatos');
            headerContacts.innerHTML = `
                <a href="https://wa.me/5586994275801" target="_blank" class="hover:text-black hover:underline">(86) 99427-5801</a> / 
                <a href="https://wa.me/5588994139399" target="_blank" class="hover:text-black hover:underline">(88) 99413-9399</a>
            `;

            // Atualiza marca d'água
            atualizarTituloDocumento();

            // Campos simples
            const map = {
                'clinicaNome': 'printClinicaNome',
                'clinicaCrmv': 'printCrmv',
                'clinicaEndereco': 'printEndereco',
                // 'clinicaContatos': 'printContatos', // Handled manually
                'animalNome': 'printAnimal',
                // 'animalIdade': 'printIdade', // Handled manually above
                'tutorNome': 'printTutor',
                'tutorCPF': 'printCpf',
                'animalPeso': 'printPeso',
                'paramTemp': 'printTemp',
                'paramFC': 'printFC',
                'paramFR': 'printFR',
                'paramTPC': 'printTPC',
                // 'paramMucosas': 'printMucosas', // Handled manually above
                'textoAnamnese': 'printAnamnese',
                'textoDiagnostico': 'printDiagnostico'
            };

            for (const [inputId, printId] of Object.entries(map)) {
                const input = document.getElementById(inputId);
                const output = document.getElementById(printId);
                if (input && output) {
                    output.innerText = input.value || (input.tagName === 'SELECT' ? '' : '---');
                    
                    if (inputId === 'textoAnamnese') {
                        document.getElementById('boxAnamnese').style.display = input.value ? 'block' : 'none';
                    }
                    if (inputId === 'textoDiagnostico') {
                        document.getElementById('boxDiagnostico').style.display = input.value ? 'block' : 'none';
                    }
                }
            }

            // GERAÇÃO DO TEXTO DA PRESCRIÇÃO
            const divTratamento = document.getElementById('printTratamento');
            let htmlReceita = '';

            if (listaReceita.length > 0) {
                htmlReceita += '<ul style="list-style: none; padding: 0; margin: 0;">';
                listaReceita.forEach((item, index) => {
                    htmlReceita += `<li style="margin-bottom: 8px;">${index + 1}. ${item.texto}</li>`;
                });
                htmlReceita += '</ul>';
            }

            const orientacoes = document.getElementById('textoOrientacoes').value;
            if (orientacoes) {
                if (listaReceita.length > 0) htmlReceita += '<br><hr style="border-top: 1px dashed #ccc; margin: 10px 0;"><br>';
                htmlReceita += `<div style="font-size: 0.95em; color: #444;">${orientacoes.replace(/\n/g, '<br>')}</div>`;
            }

            if (!htmlReceita) htmlReceita = '---';
            divTratamento.innerHTML = htmlReceita;

            // Parametros box logic
            const temParametros = ['paramTemp', 'paramFC', 'paramFR', 'animalPeso'].some(id => document.getElementById(id).value);
            document.getElementById('printParametrosBox').classList.toggle('hidden', !temParametros);

            // Data por extenso
            const dataInput = document.getElementById('dataAtendimento').value;
            if (dataInput) {
                const date = new Date(dataInput + 'T00:00:00');
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('printDataExtenso').innerText = date.toLocaleDateString('pt-BR', options);
            }

            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('report-view').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function editarRelatorio() {
            document.getElementById('report-view').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function limparFormulario() {
            if(confirm("Deseja limpar todos os campos?")) {
                document.getElementById('vetForm').reset();
                document.getElementById('dataAtendimento').valueAsDate = new Date();
                listaReceita = [];
                renderizarListaReceita();
                atualizarRacas(); 
                cancelarEspecieManual(); 
                cancelarTipoDocManual(); 
                cancelarSexoManual(); 
                cancelarMucosasManual(); 
                cancelarMedicamentoManual(); // New
                cancelarDosagemManual(); // New
                cancelarFrequenciaManual(); // New
                cancelarTempoManual(); // New
            }
        }

        function exportarParaCSV() {
            // Lógica Tipo Doc CSV
            let tipoDocCSV = "";
            const selectTipoDoc = document.getElementById('tipoDocumento');
            if (selectTipoDoc.value === 'Outra (Digitar)') {
                tipoDocCSV = document.getElementById('tipoDocumentoManual').value || "DOCUMENTO";
            } else {
                tipoDocCSV = selectTipoDoc.value;
            }

            // Lógica Especie CSV
            let especieCSV = "";
            const selectEspecie = document.getElementById('animalEspecie');
            if (selectEspecie.value === 'Outra (Digitar)') {
                especieCSV = document.getElementById('animalEspecieManual').value;
            } else {
                especieCSV = selectEspecie.value;
            }

            // Lógica Raca CSV
            let racaCSV = "";
            const selectRaca = document.getElementById('animalRacaSelect');
            if (selectRaca.value === 'Outra (Digitar)') {
                racaCSV = document.getElementById('animalRacaManual').value;
            } else {
                racaCSV = selectRaca.value;
            }

            // Lógica Sexo CSV
            let sexoCSV = "";
            const selectSexo = document.getElementById('animalSexo');
            if (selectSexo.value === 'Outro (Digitar)') {
                sexoCSV = document.getElementById('animalSexoManual').value;
            } else {
                sexoCSV = selectSexo.value;
            }

            // Lógica Mucosas CSV
            let mucosasCSV = "";
            const selectMucosas = document.getElementById('paramMucosas');
            if (selectMucosas.value === 'Outro (Digitar)') {
                mucosasCSV = document.getElementById('paramMucosasManual').value;
            } else {
                mucosasCSV = selectMucosas.value;
            }

            // Lógica Idade CSV
            const idadeVal = document.getElementById('animalIdadeValor').value;
            const idadeTipo = document.getElementById('animalIdadeTipo').value;
            const idadeCSV = idadeVal ? `${idadeVal} ${idadeTipo}` : '';

            // Coleta dados
            const dados = {
                Data: document.getElementById('dataAtendimento').value,
                Tipo: tipoDocCSV,
                Animal: document.getElementById('animalNome').value,
                Especie: especieCSV,
                Raca: racaCSV,
                Idade: idadeCSV,
                Peso: document.getElementById('animalPeso').value,
                Sexo: sexoCSV,
                Tutor: document.getElementById('tutorNome').value,
                CPF: document.getElementById('tutorCPF').value,
                Anamnese: document.getElementById('textoAnamnese').value,
                Diagnostico: document.getElementById('textoDiagnostico').value,
                Mucosas: mucosasCSV,
                Receita: listaReceita.map(i => i.texto.replace(/<[^>]*>/g, '')).join('; ') // Remove HTML tags
            };

            // Linha de dados (escapando aspas e quebras de linha)
            const values = Object.values(dados).map(val => {
                const stringVal = String(val || '');
                return `"${stringVal.replace(/"/g, '""')}"`; // Escapa aspas duplas
            });

            // Apenas os valores, sem cabeçalho
            const csvContent = values.join(','); 

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `Dados_${dados.Animal}_${dados.Data}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function baixarPDF() {
            const element = document.getElementById('documento-final');
            
            const animal = document.getElementById('printAnimal').innerText.trim() || "SemNome";
            
            // Pegar a data do input para formatar
            const dataInput = document.getElementById('dataAtendimento').value;
            let dataFormatada = "";
            if(dataInput) {
                const partes = dataInput.split('-'); // AAAA-MM-DD
                dataFormatada = `${partes[2]}-${partes[1]}-${partes[0]}`; // DD-MM-AAAA
            } else {
                // Fallback para data de hoje se não houver no input
                const hoje = new Date();
                dataFormatada = hoje.toLocaleDateString('pt-BR').replace(/\//g, '-');
            }

            const nomeFixo = "DR.MANUEL VICTOR - CRMV-PI 02120 VP";
            
            // Montar o nome final
            // Ex: BRENDA_30-12-2025_DR.MANUEL VICTOR - CRMV-PI 02120 VP.pdf
            const nomeArquivo = `${animal}_${dataFormatada}_${nomeFixo}.pdf`;
            
            // Calcula a altura em mm baseada no conteúdo (1px = 0.264583 mm)
            // Adiciona uma margem de segurança
            const contentHeight = element.scrollHeight * 0.264583; 
            const finalHeight = Math.max(contentHeight, 297); // No mínimo A4

            const opt = {
                margin: 0,
                filename: nomeArquivo,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: [210, finalHeight], orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save();
        }
    </script>
</body>
</html>
